cmake_minimum_required(VERSION 3.15)
project(NewRegister VERSION 0.1.0 LANGUAGES C CXX)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# --- Dependencies ---

# 1. GLFW
find_package(glfw3 REQUIRED)

# 2. Vulkan
find_package(Vulkan REQUIRED)

# 2.5 HDF5 (Required by minc2 headers)
find_package(HDF5 REQUIRED COMPONENTS C)

# 3. Dear ImGui (Docking Branch)
include(FetchContent)
FetchContent_Declare(
    imgui
    GIT_REPOSITORY https://github.com/ocornut/imgui
    GIT_TAG        docking
)
FetchContent_MakeAvailable(imgui)

# 3.5. Glaze (JSON serialization)
FetchContent_Declare(
    glaze
    GIT_REPOSITORY https://github.com/stephenberry/glaze.git
    GIT_TAG        v4.2.3
    GIT_SHALLOW    TRUE
)
FetchContent_MakeAvailable(glaze)

# 3.75. GLM (Math library for vector/matrix operations)
include(FetchContent)
FetchContent_Declare(
    glm
    GIT_REPOSITORY https://github.com/g-truc/glm.git
    GIT_TAG        1.0.1
    GIT_SHALLOW    TRUE
)
FetchContent_MakeAvailable(glm)

# Create ImGui library target
add_library(imgui STATIC
    ${imgui_SOURCE_DIR}/imgui.cpp
    ${imgui_SOURCE_DIR}/imgui_demo.cpp
    ${imgui_SOURCE_DIR}/imgui_draw.cpp
    ${imgui_SOURCE_DIR}/imgui_tables.cpp
    ${imgui_SOURCE_DIR}/imgui_widgets.cpp
)
target_include_directories(imgui PUBLIC ${imgui_SOURCE_DIR})

# 4. LIBMINC (Internal Source Build)
# We add the legacy/libminc directory. 
# We disable testing/examples/nifti for libminc to speed up build and avoid clutter.
set(LIBMINC_BUILD_SHARED_LIBS OFF CACHE BOOL "Build shared libs" FORCE)
set(LIBMINC_MINC1_SUPPORT OFF CACHE BOOL "Enable MINC1" FORCE)
set(LIBMINC_BUILD_EZMINC OFF CACHE BOOL "Build EZMINC" FORCE)
set(LIBMINC_BUILD_VIO ON CACHE BOOL "Build VolumeIO" FORCE) 
set(LIBMINC_USE_NIFTI OFF CACHE BOOL "Use NIfTI" FORCE)
set(BUILD_TESTING OFF CACHE BOOL "Build tests" FORCE)

add_subdirectory(${CMAKE_SOURCE_DIR}/../legacy/libminc libminc)

# 5. minc2-simple (Internal Source Build)
# Define minc2-simple library target manually to integrate with libminc target
add_library(minc2_simple STATIC
    ${CMAKE_SOURCE_DIR}/../legacy/minc2-simple/src/minc2-simple.c
    ${CMAKE_SOURCE_DIR}/../legacy/minc2-simple/src/minc2-matrix-ops.c
)
target_include_directories(minc2_simple PUBLIC 
    ${CMAKE_SOURCE_DIR}/../legacy/minc2-simple/src
    ${CMAKE_SOURCE_DIR}/../legacy/libminc/libsrc2 # For minc2.h
    ${CMAKE_SOURCE_DIR}/../legacy/libminc/libcommon # For minc_common_defs.h
    ${CMAKE_SOURCE_DIR}/../legacy/libminc/volume_io/Include # For volume_io.h
    ${CMAKE_SOURCE_DIR}/../legacy/libminc/libsrc # For minc.h
    ${CMAKE_BINARY_DIR}/libminc # For config.h generated by libminc
)
# Link against the 'minc2' target created by libminc subdirectory
if(TARGET minc2)
    target_link_libraries(minc2_simple PUBLIC minc2 HDF5::HDF5)
else()
    message(FATAL_ERROR "Target 'minc2' not found after adding legacy/libminc")
endif()

# --- Sources ---
file(GLOB_RECURSE SOURCES 
    "src/*.cpp" 
    "include/*.h"
)

# ImGui Backends (Vulkan + GLFW)
set(IMGUI_DIR ${imgui_SOURCE_DIR})
list(APPEND SOURCES
    ${IMGUI_DIR}/backends/imgui_impl_glfw.cpp
    ${IMGUI_DIR}/backends/imgui_impl_vulkan.cpp
)

# --- Executable ---
add_executable(new_register ${SOURCES})

# --- Include Directories ---
target_include_directories(new_register PRIVATE
    include
    ${IMGUI_DIR}
    ${IMGUI_DIR}/backends
    ${glm_SOURCE_DIR}  # GLM is header-only
    # Also include minc2-simple public headers path (already handled by PUBLIC on minc2_simple target?)
    # Yes, linking against minc2_simple propagates usage requirements.
)

# --- Linking ---
target_link_libraries(new_register PRIVATE
    glfw
    Vulkan::Vulkan
    imgui
    minc2_simple
    glaze::glaze
    glm
)

# Definitions
target_compile_definitions(new_register PRIVATE 
    # IMGUI_IMPL_VULKAN_NO_PROTOTYPES # We link against standard loader
)

# --- Testing ---
enable_testing()

add_executable(test_real_data tests/test_real_data.cpp src/Volume.cpp)
target_include_directories(test_real_data PRIVATE include)
target_link_libraries(test_real_data PRIVATE minc2_simple)

# The test needs access to test_data, we assume it's run from build directory or we pass full path
# We'll pass the full path to the test executable
add_test(NAME ReadRealData COMMAND test_real_data 
    ${CMAKE_SOURCE_DIR}/../test_data/mni_icbm152_t1_tal_nlin_sym_09c.mnc
    ${CMAKE_SOURCE_DIR}/../test_data/mni_icbm152_t1_tal_nlin_sym_09c_mask.mnc
)

add_executable(test_colour_map tests/test_colour_map.cpp src/ColourMap.cpp)
target_include_directories(test_colour_map PRIVATE include)
add_test(NAME ColourMapTests COMMAND test_colour_map)
